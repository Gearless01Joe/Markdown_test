# RCSB_PDB é¡¹ç›®ç¼ºå¤±æ–‡ä»¶æ¸…å•

æ ¹æ®ä»£ç ä¸­çš„å¯¼å…¥è¯­å¥å’Œæ–‡æ¡£å¼•ç”¨ï¼Œä»¥ä¸‹æ˜¯éœ€è¦è¡¥å……çš„æ–‡ä»¶åˆ—è¡¨ã€‚

## 1. ç›®å½•ç»“æ„é—®é¢˜

### 1.1 å¯¼å…¥è·¯å¾„ä¸åŒ¹é…
- **é—®é¢˜**ï¼šä»£ç ä¸­å¯¼å…¥ `from src.items.other.rcsb_pdb_item import RcsbAllApiItem`
- **å®é™…ä½ç½®**ï¼š`src/items/rcsb_pdb_item.py`ï¼ˆæ²¡æœ‰ `other` å­ç›®å½•ï¼‰
- **è§£å†³æ–¹æ¡ˆ**ï¼š
  - é€‰é¡¹Aï¼šåˆ›å»º `src/items/other/` ç›®å½•ï¼Œå°† `rcsb_pdb_item.py` ç§»åŠ¨åˆ°è¯¥ç›®å½•
  - é€‰é¡¹Bï¼šä¿®æ”¹æ‰€æœ‰å¯¼å…¥è¯­å¥ï¼Œå°† `src.items.other.rcsb_pdb_item` æ”¹ä¸º `src.items.rcsb_pdb_item`

## 2. ç¼ºå¤±çš„æ ¸å¿ƒæ¨¡å—æ–‡ä»¶

### 2.1 å·¥å…·ç±»æ¨¡å— (`src/utils/`)
ä»¥ä¸‹æ–‡ä»¶åœ¨ä»£ç ä¸­è¢«å¼•ç”¨ï¼Œä½†ç›®å½•ä¸å­˜åœ¨ï¼š

- âœ… **`src/utils/__init__.py`** - å·¥å…·æ¨¡å—åˆå§‹åŒ–æ–‡ä»¶
- âœ… **`src/utils/mongodb_manager.py`** - MongoDB æ•°æ®åº“æ“ä½œå·¥å…·ç±»
  - åŒ…å« `MongoDBManager` ç±»
  - è¢« `rcsb_pdb_spider.py` å¯¼å…¥ï¼š`from src.utils.mongodb_manager import MongoDBManager`
  - **éœ€è¦å®ç°çš„æ–¹æ³•/å±æ€§**ï¼š
    - `MongoDBManager()` - æ„é€ å‡½æ•°ï¼Œä» `settings.py` çš„ `MONGODB_DATABASES` è¯»å–é…ç½®
    - `self.db` - æ•°æ®åº“å¯¹è±¡ï¼ˆMongoDB Databaseï¼‰ï¼Œç”¨äºè®¿é—®é›†åˆï¼Œå¦‚ `self.mongo_manager.db[collection_name]`
- âœ… **`src/utils/redis_manager.py`** - Redis æ•°æ®åº“ç®¡ç†ç±»
  - åŒ…å« `RedisManager` ç±»
  - è¢« `rcsb_pdb_spider.py` å¯¼å…¥ï¼š`from src.utils.redis_manager import RedisManager`
  - **éœ€è¦å®ç°çš„æ–¹æ³•/å±æ€§**ï¼š
    - `RedisManager()` - æ„é€ å‡½æ•°ï¼Œä» `settings.py` çš„ `REDIS_DATABASES` è¯»å–é…ç½®
    - `get_connection()` - è¿”å› Redis è¿æ¥å¯¹è±¡ï¼Œå¦‚ `RedisManager().get_connection()`
- âœ… **`src/utils/base_logger.py`** - æ—¥å¿—é…ç½®æ¨¡å—
  - è¢« `settings.py` å¯¼å…¥ï¼š`import src.utils.base_logger`

### 2.2 åŸºç¡€ Item æ¨¡å— (`src/items/`)
- âœ… **`src/items/__init__.py`** - Items æ¨¡å—åˆå§‹åŒ–æ–‡ä»¶
- âœ… **`src/items/base_items.py`** - åŸºç¡€ Item ç±»å®šä¹‰
  - åŒ…å« `BaseItem`ã€`StringField`ã€`FileOSSField` ç±»
  - è¢« `rcsb_pdb_item.py` å¯¼å…¥ï¼š`from src.items.base_items import BaseItem, StringField, FileOSSField`
  - **éœ€è¦å®ç°çš„ç±»**ï¼š
    - `BaseItem` - åŸºç¡€ Item ç±»ï¼Œå¯èƒ½ç»§æ‰¿è‡ª `scrapy.Item` æˆ–æä¾›é¢å¤–åŠŸèƒ½
    - `StringField` - å­—ç¬¦ä¸²å­—æ®µç±»å‹ï¼ˆå¯èƒ½ç»§æ‰¿è‡ª `scrapy.Field`ï¼‰
    - `FileOSSField` - æ–‡ä»¶ OSS å­—æ®µç±»å‹ï¼Œæ¥å—å‚æ•°ï¼š
      - `bucket_sign` - OSS bucket æ ‡è¯†ï¼ˆå¦‚ "local"ï¼‰
      - `oss_path_sign` - OSS è·¯å¾„æ ‡è¯†ï¼ˆå¦‚ "rcsb_pdb_all"ï¼‰

### 2.3 Pipeline åŸºç±»æ¨¡å— (`src/pipelines/`)
- âœ… **`src/pipelines/__init__.py`** - Pipelines æ¨¡å—åˆå§‹åŒ–æ–‡ä»¶
- âœ… **`src/pipelines/raw_storage_pipeline.py`** - MongoDB å­˜å‚¨ Pipeline åŸºç±»
  - åŒ…å« `MongoDBRawStoragePipeline` ç±»
  - è¢« `rcsb_pdb_pipeline.py` å¯¼å…¥ï¼š`from src.pipelines.raw_storage_pipeline import MongoDBRawStoragePipeline`
  - **éœ€è¦å®ç°çš„åŸºç±»**ï¼šç»§æ‰¿è‡ª Scrapy çš„ Pipeline åŸºç±»ï¼Œæä¾› MongoDB å­˜å‚¨åŠŸèƒ½
  - **å­ç±»éœ€è¦è¦†ç›–çš„å±æ€§**ï¼š
    - `connect_key` - è¿æ¥é…ç½®çš„ keyï¼ˆå¦‚ "default"ï¼‰
    - `collection_name` - MongoDB é›†åˆåç§°ï¼ˆå¦‚ "rcsb_pdb_structures_all"ï¼‰
    - `item_class` - æœŸæœ›çš„ Item ç±»å‹ï¼ˆå¦‚ `RcsbAllApiItem`ï¼‰

### 2.4 å¸¸é‡æ¨¡å—
- âœ… **`src/constant.py`** - é¡¹ç›®å¸¸é‡å®šä¹‰
  - åŒ…å« `LOG_PATH`ã€`UPLOAD_PATH` å¸¸é‡
  - è¢« `settings.py` å¯¼å…¥ï¼š`from src.constant import LOG_PATH, UPLOAD_PATH`
  - **éœ€è¦å®šä¹‰çš„å¸¸é‡**ï¼š
    - `LOG_PATH` - æ—¥å¿—æ–‡ä»¶å­˜æ”¾è·¯å¾„ï¼ˆå­—ç¬¦ä¸²æˆ– Path å¯¹è±¡ï¼‰
    - `UPLOAD_PATH` - ä¸Šä¼ æ–‡ä»¶å­˜æ”¾è·¯å¾„ï¼ˆå­—ç¬¦ä¸²æˆ– Path å¯¹è±¡ï¼‰

### 2.5 ä¸­é—´ä»¶æ¨¡å— (`src/middlewares/`) - å¯é€‰
æ ¹æ®æ–‡æ¡£å’Œæ¶æ„è¯´æ˜ï¼Œä»¥ä¸‹ä¸­é—´ä»¶å¯èƒ½è¢«ä½¿ç”¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼š
- âš ï¸ **`src/middlewares/__init__.py`** - ä¸­é—´ä»¶æ¨¡å—åˆå§‹åŒ–æ–‡ä»¶
- âš ï¸ **`src/middlewares/captcha_middleware.py`** - éªŒè¯ç æ‹¦æˆªä¸­é—´ä»¶ï¼ˆæ–‡æ¡£ä¸­æåˆ°ï¼‰
- âš ï¸ **`src/middlewares/custom_retry_middleware.py`** - è‡ªå®šä¹‰é‡è¯•ä¸­é—´ä»¶ï¼ˆæ–‡æ¡£ä¸­æåˆ°ï¼‰
- âš ï¸ **`src/middlewares/base_proxy_middleware.py`** - ä»£ç†æ³¨å…¥ä¸­é—´ä»¶ï¼ˆæ–‡æ¡£ä¸­æåˆ°ï¼‰
- âš ï¸ **`src/middlewares/history_data_middleware.py`** - å†å²æ•°æ®è¿‡æ»¤ä¸­é—´ä»¶ï¼ˆæ–‡æ¡£ä¸­æåˆ°ï¼‰
- âš ï¸ **`src/middlewares/proxy_middleware.py`** - ä»£ç†ä¸­é—´ä»¶ï¼ˆREADME ä¸­æåˆ°ï¼‰
- âš ï¸ **`src/middlewares/retry_middleware.py`** - è‡ªå®šä¹‰é‡è¯•é€»è¾‘ï¼ˆREADME ä¸­æåˆ°ï¼‰

### 2.6 æ–‡ä»¶ä¸‹è½½ Pipeline - å¯é€‰
æ ¹æ®æ–‡æ¡£è¯´æ˜ï¼š
- âš ï¸ **`src/pipelines/file_download_pipeline.py`** - æ–‡ä»¶ä¸‹è½½ç®¡é“ï¼ˆCIFã€éªŒè¯å›¾ç‰‡ï¼‰

## 3. ç¼ºå¤±çš„ `__init__.py` æ–‡ä»¶

ä»¥ä¸‹ç›®å½•éœ€è¦ `__init__.py` æ–‡ä»¶æ‰èƒ½è¢« Python è¯†åˆ«ä¸ºåŒ…ï¼š

- âœ… **`src/__init__.py`** - æ ¹æ¨¡å—åˆå§‹åŒ–æ–‡ä»¶
- âœ… **`src/items/__init__.py`** - Items æ¨¡å—åˆå§‹åŒ–æ–‡ä»¶
- âœ… **`src/pipelines/__init__.py`** - Pipelines æ¨¡å—åˆå§‹åŒ–æ–‡ä»¶
- âœ… **`src/utils/__init__.py`** - Utils æ¨¡å—åˆå§‹åŒ–æ–‡ä»¶
- âš ï¸ **`src/middlewares/__init__.py`** - Middlewares æ¨¡å—åˆå§‹åŒ–æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

## 4. ä¼˜å…ˆçº§åˆ†ç±»

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»è¡¥å……ï¼Œå¦åˆ™ä»£ç æ— æ³•è¿è¡Œï¼‰
1. `src/__init__.py`
2. `src/utils/__init__.py`
3. `src/utils/mongodb_manager.py` - MongoDBManager ç±»
4. `src/utils/redis_manager.py` - RedisManager ç±»
5. `src/utils/base_logger.py` - æ—¥å¿—é…ç½®
6. `src/items/__init__.py`
7. `src/items/base_items.py` - BaseItem, StringField, FileOSSField
8. `src/pipelines/__init__.py`
9. `src/pipelines/raw_storage_pipeline.py` - MongoDBRawStoragePipeline åŸºç±»
10. `src/constant.py` - LOG_PATH, UPLOAD_PATH
11. è§£å†³å¯¼å…¥è·¯å¾„é—®é¢˜ï¼ˆ`src.items.other.rcsb_pdb_item` vs `src.items.rcsb_pdb_item`ï¼‰

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®è¡¥å……ï¼Œæå‡åŠŸèƒ½å®Œæ•´æ€§ï¼‰
1. `src/middlewares/` ç›®å½•åŠç›¸å…³ä¸­é—´ä»¶æ–‡ä»¶ï¼ˆå¦‚æœé¡¹ç›®ä½¿ç”¨ä¸­é—´ä»¶ï¼‰
2. `src/pipelines/file_download_pipeline.py`ï¼ˆå¦‚æœé¡¹ç›®éœ€è¦æ–‡ä»¶ä¸‹è½½åŠŸèƒ½ï¼‰
3. `src/utils/mysql_manager.py` - MySQL æ•°æ®åº“æ“ä½œå·¥å…·ç±»ï¼ˆREADME ä¸­æåˆ°ï¼Œä½†å½“å‰é¡¹ç›®ä¸»è¦ä½¿ç”¨ MongoDBï¼‰

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼Œæ ¹æ®å®é™…éœ€æ±‚ï¼‰
1. `src/utils/base_oss.py` - OSS ç›¸å…³æ–‡ä»¶ä¸Šä¼ ç±»ï¼ˆå¦‚æœä½¿ç”¨ OSS å­˜å‚¨ï¼‰
2. `src/utils/base_language_detection.py` - è¯­è¨€æ£€æµ‹å·¥å…·
3. `src/utils/base_token.py` - èº«ä»½ä»¤ç‰Œç±»
4. `src/utils/blm_server.py` - æ¨¡å‹è¯·æ±‚ç±»

## 5. æ£€æŸ¥æ¸…å•

åœ¨è¡¥å……æ–‡ä»¶åï¼Œè¯·ç¡®è®¤ï¼š

- [ ] æ‰€æœ‰ `__init__.py` æ–‡ä»¶å·²åˆ›å»º
- [ ] `MongoDBManager` ç±»å·²å®ç°ï¼ŒåŒ…å«æ•°æ®åº“è¿æ¥å’Œæ“ä½œæ–¹æ³•
- [ ] `RedisManager` ç±»å·²å®ç°ï¼ŒåŒ…å«è¿æ¥æ± å’ŒåŸºæœ¬æ“ä½œæ–¹æ³•
- [ ] `BaseItem`ã€`StringField`ã€`FileOSSField` å·²å®ç°
- [ ] `MongoDBRawStoragePipeline` åŸºç±»å·²å®ç°ï¼ŒåŒ…å« `connect_key`ã€`collection_name`ã€`item_class` ç­‰å±æ€§
- [ ] `src/constant.py` ä¸­å®šä¹‰äº† `LOG_PATH` å’Œ `UPLOAD_PATH`
- [ ] `base_logger.py` æä¾›äº†æ—¥å¿—é…ç½®åŠŸèƒ½
- [ ] å¯¼å…¥è·¯å¾„é—®é¢˜å·²è§£å†³ï¼ˆç»Ÿä¸€ä½¿ç”¨ `src.items.rcsb_pdb_item` æˆ–åˆ›å»º `src/items/other/` ç›®å½•ï¼‰

## 6. å»ºè®®çš„æ–‡ä»¶ç»“æ„

```
RCSB_PDB/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py                    âœ… éœ€è¦åˆ›å»º
â”‚   â”œâ”€â”€ constant.py                    âœ… éœ€è¦åˆ›å»º
â”‚   â”œâ”€â”€ settings.py                    âœ… å·²å­˜åœ¨
â”‚   â”œâ”€â”€ items/
â”‚   â”‚   â”œâ”€â”€ __init__.py                âœ… éœ€è¦åˆ›å»º
â”‚   â”‚   â”œâ”€â”€ base_items.py              âœ… éœ€è¦åˆ›å»º
â”‚   â”‚   â”œâ”€â”€ rcsb_pdb_item.py          âœ… å·²å­˜åœ¨
â”‚   â”‚   â””â”€â”€ other/                     âš ï¸ å¯é€‰ï¼ˆå¦‚æœä¿ç•™å¯¼å…¥è·¯å¾„ï¼‰
â”‚   â”‚       â””â”€â”€ rcsb_pdb_item.py      âš ï¸ å¯é€‰ï¼ˆç§»åŠ¨ç°æœ‰æ–‡ä»¶ï¼‰
â”‚   â”œâ”€â”€ pipelines/
â”‚   â”‚   â”œâ”€â”€ __init__.py                âœ… éœ€è¦åˆ›å»º
â”‚   â”‚   â”œâ”€â”€ raw_storage_pipeline.py   âœ… éœ€è¦åˆ›å»º
â”‚   â”‚   â”œâ”€â”€ rcsb_pdb_pipeline.py      âœ… å·²å­˜åœ¨
â”‚   â”‚   â””â”€â”€ file_download_pipeline.py âš ï¸ å¯é€‰
â”‚   â”œâ”€â”€ spider/
â”‚   â”‚   â””â”€â”€ rcsb_pdb/
â”‚   â”‚       â”œâ”€â”€ __init__.py            âœ… å·²å­˜åœ¨
â”‚   â”‚       â”œâ”€â”€ rcsb_pdb_spider.py    âœ… å·²å­˜åœ¨
â”‚   â”‚       â”œâ”€â”€ field_filter.py       âœ… å·²å­˜åœ¨
â”‚   â”‚       â””â”€â”€ field_filter_config.json âœ… å·²å­˜åœ¨
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ __init__.py                âœ… éœ€è¦åˆ›å»º
â”‚   â”‚   â”œâ”€â”€ base_logger.py             âœ… éœ€è¦åˆ›å»º
â”‚   â”‚   â”œâ”€â”€ mongodb_manager.py         âœ… éœ€è¦åˆ›å»º
â”‚   â”‚   â””â”€â”€ redis_manager.py           âœ… éœ€è¦åˆ›å»º
â”‚   â””â”€â”€ middlewares/                   âš ï¸ å¯é€‰
â”‚       â”œâ”€â”€ __init__.py                âš ï¸ å¯é€‰
â”‚       â””â”€â”€ ...                       âš ï¸ å¯é€‰
â””â”€â”€ ...
```

## 7. ä¸‹ä¸€æ­¥æ“ä½œ

1. é¦–å…ˆè§£å†³å¯¼å…¥è·¯å¾„é—®é¢˜ï¼ˆé€‰æ‹©é€‰é¡¹Aæˆ–Bï¼‰
2. åˆ›å»ºæ‰€æœ‰å¿…éœ€çš„ `__init__.py` æ–‡ä»¶
3. å®ç°æ ¸å¿ƒå·¥å…·ç±»ï¼ˆMongoDBManager, RedisManagerï¼‰
4. å®ç°åŸºç¡€ç±»ï¼ˆBaseItem, MongoDBRawStoragePipelineï¼‰
5. åˆ›å»ºå¸¸é‡æ–‡ä»¶
6. æµ‹è¯•å¯¼å…¥æ˜¯å¦æ­£å¸¸


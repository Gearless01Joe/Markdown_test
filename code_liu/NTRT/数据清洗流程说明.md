# 数据清洗流程详解

## 一、整体架构

```
DataCleaner (数据清洗类)
├── 数据处理层（静态方法）
│   ├── _process_cited_articles()      # 处理引用文献数组
│   ├── _process_breadth_search()      # 处理广度搜索结果
│   └── _standardize_project_info()    # 标准化项目信息
│
├── 数据库操作层（实例方法）
│   ├── _open_session()                # 打开数据库会话
│   ├── _fetch_records_with_condition() # 查询记录
│   ├── _process_records()              # 处理记录
│   └── _write_updates()                # 写入更新
│
└── 业务逻辑层（公开方法）
    ├── clean_breadth_search()         # 清洗breadth_search字段
    ├── clean_cited_articles_topic()    # 清洗主题列表cited_articles
    ├── clean_cited_articles_app()     # 清洗应用信息cited_articles
    └── run_all()                       # 执行所有清洗任务
```

## 二、执行流程（以 clean_breadth_search 为例）

### 流程图

```
run_all()
  │
  └─> clean_breadth_search()
        │
        ├─> 步骤1: _fetch_records_with_condition()
        │     │
        │     ├─> _open_session()                    # 打开数据库连接
        │     │
        │     └─> model.fetch_records_for_cleaning()  # 调用模型类查询
        │           │
        │           └─> 返回: [{'id': 1, 'breadth_search': {...}}, ...]
        │
        ├─> 步骤2: _process_records()
        │     │
        │     ├─> 遍历每条记录
        │     │     │
        │     │     ├─> 解析JSON数据
        │     │     │
        │     │     └─> _process_breadth_search()    # 回调函数处理数据
        │     │           │
        │     │           └─> _standardize_project_info()  # 标准化项目数据
        │     │
        │     └─> 返回: (updates, processed, skipped)
        │
        └─> 步骤3: _write_updates()
              │
              ├─> _open_session()                    # 打开数据库连接
              │
              └─> model.batch_update_field()         # 批量更新数据库
                    │
                    └─> session.commit()              # 提交事务
```

## 三、函数调用层次

### 层次1：入口层（用户调用）

```python
run_all()  # 或 run_all(db_key='medicine_test')
  └─> DataCleaner(db_key).run_all()
```

### 层次2：业务逻辑层（清洗任务）

```python
run_all()
  ├─> clean_breadth_search()
  ├─> clean_cited_articles_topic()
  └─> clean_cited_articles_app()
```

每个清洗方法都遵循相同的三步流程：
1. **查询** → `_fetch_records_with_condition()`
2. **处理** → `_process_records()`
3. **更新** → `_write_updates()`

### 层次3：数据库操作层（通用方法）

```python
# 查询记录
_fetch_records_with_condition(model_class, field_name, condition)
  ├─> _open_session()                    # 获取数据库会话
  └─> model.fetch_records_for_cleaning() # 调用模型类方法

# 处理记录
_process_records(records, field_name, processor_func)
  └─> processor_func(parsed_payload)     # 回调函数处理数据

# 写入更新
_write_updates(model_class, field_name, updates)
  ├─> _open_session()                    # 获取数据库会话
  └─> model.batch_update_field()        # 调用模型类方法
```

### 层次4：数据处理层（静态方法）

```python
# 处理引用文献数组
_process_cited_articles(data)
  └─> _standardize_project_info()       # 如果是项目类型

# 处理广度搜索结果
_process_breadth_search(data)
  └─> _standardize_project_info()       # 处理项目数据

# 标准化项目信息
_standardize_project_info(object_info)
  └─> 字段映射、格式转换、添加类型标识
```

### 层次5：ORM模型层（数据库操作）

```python
# 在 NsfcTopicRcmdModels.py 中
model.fetch_records_for_cleaning(db, field_name, condition)
  └─> 使用 BaseCRUD.get_list_info() 或 text() 执行SQL

model.batch_update_field(db, field_name, updates, batch_size)
  └─> 使用 BaseCRUD.update_data_info() 批量更新
```

## 四、回调机制

### 回调函数的使用

在 `_process_records()` 方法中，使用**函数指针（回调）**来灵活处理不同类型的数据：

```python
def _process_records(self, records, field_name, processor_func):
    """processor_func 是一个回调函数"""
    for record in records:
        # ... 解析JSON ...
        processed_payload = processor_func(parsed_payload)  # 调用回调
        # ...
```

### 三种回调函数

1. **`_process_breadth_search`** - 用于处理 `breadth_search` 字段
   - 合并 `project_addition` 和 `article_addition`
   - 对项目数据调用 `_standardize_project_info()`

2. **`_process_cited_articles`** - 用于处理 `cited_articles` 字段
   - 将数组转换为字典（以 `object_id` 为键）
   - 对项目类型调用 `_standardize_project_info()`

3. **`_standardize_project_info`** - 标准化项目数据
   - 字段映射（`unit_name` → `project_unit`）
   - 格式转换（`project_keyword` 字符串转数组）
   - 添加类型标识（`type: 'nsfc_project'`）

## 五、数据流向

### 示例：清洗 breadth_search 字段

```
数据库
  │
  ├─> [原始数据]
  │   {
  │     "project_addition": {"123": {...}},
  │     "article_addition": {"456": {...}}
  │   }
  │
  ▼
_fetch_records_with_condition()
  │
  ├─> 查询条件: breadth_search LIKE '%article_addition%' OR ...
  │
  └─> 返回: [{'id': 1, 'breadth_search': {...}}, ...]
  │
  ▼
_process_records()
  │
  ├─> 遍历每条记录
  │   │
  │   ├─> 解析JSON: json.loads() 或直接使用 dict
  │   │
  │   └─> 调用回调: _process_breadth_search(parsed_data)
  │         │
  │         ├─> 处理 project_addition
  │         │     └─> _standardize_project_info() → 标准化
  │         │
  │         └─> 处理 article_addition → 直接复制
  │
  └─> 返回: (updates, processed, skipped)
  │   updates = [(1, {标准化后的数据}), ...]
  │
  ▼
_write_updates()
  │
  ├─> 批量更新: model.batch_update_field()
  │   │
  │   └─> 每批100条记录
  │
  └─> 提交事务: session.commit()
  │
  ▼
数据库
  │
  └─> [清洗后的数据]
      {
        "123": {标准化后的项目数据},
        "456": {原始文章数据}
      }
```

## 六、关键设计模式

### 1. 模板方法模式

`clean_breadth_search()`、`clean_cited_articles_topic()`、`clean_cited_articles_app()` 都遵循相同的三步模板：
- 查询 → 处理 → 更新

### 2. 策略模式（回调函数）

通过传递不同的 `processor_func` 来处理不同类型的数据：
- `_process_breadth_search` - 处理广度搜索
- `_process_cited_articles` - 处理引用文献

### 3. 单一职责原则

- **数据处理层**：只负责数据转换，不涉及数据库操作
- **数据库操作层**：只负责数据库交互，不涉及业务逻辑
- **业务逻辑层**：只负责协调流程，不涉及具体实现

## 七、执行时间线

```
T0: run_all() 开始
  │
T1: clean_breadth_search() 开始
  │
T2: _fetch_records_with_condition()
  │   ├─> 打开数据库连接
  │   ├─> 执行查询
  │   └─> 关闭连接
  │
T3: _process_records()
  │   ├─> 遍历记录
  │   ├─> 解析JSON
  │   ├─> 调用 _process_breadth_search()（回调）
  │   │     └─> 调用 _standardize_project_info()
  │   └─> 生成更新列表
  │
T4: _write_updates()
  │   ├─> 打开数据库连接
  │   ├─> 批量更新（每批100条）
  │   ├─> 提交事务
  │   └─> 关闭连接
  │
T5: clean_breadth_search() 完成
  │
T6: clean_cited_articles_topic() 开始
  │   └─> 重复 T2-T4 流程
  │
T7: clean_cited_articles_app() 开始
  │   └─> 重复 T2-T4 流程
  │
T8: run_all() 完成
```

## 八、总结

### 调用层次（从外到内）

1. **入口层**：`run_all()` → 用户调用
2. **业务层**：`clean_*()` → 清洗任务
3. **操作层**：`_fetch_*()`, `_process_*()`, `_write_*()` → 通用操作
4. **数据层**：`_process_*()` → 数据处理
5. **ORM层**：`model.*()` → 数据库交互

### 回调函数

- **2个主要回调**：`_process_breadth_search`、`_process_cited_articles`
- **1个辅助回调**：`_standardize_project_info`（被前两个调用）

### 设计特点

- ✅ **三层架构**：业务逻辑 → 数据库操作 → 数据处理
- ✅ **回调机制**：灵活处理不同类型数据
- ✅ **单一职责**：每个函数只做一件事
- ✅ **模板方法**：统一的清洗流程
- ✅ **ORM封装**：数据库操作封装在模型类中


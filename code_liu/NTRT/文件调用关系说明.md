# 文件调用关系详解

## 一、文件依赖关系图

```
┌─────────────────────────────────────────────────────────┐
│              application/settings.py                    │
│  (数据库配置：DATABASES字典)                            │
└───────────────────┬─────────────────────────────────────┘
                    │ 导入
                    ▼
┌─────────────────────────────────────────────────────────┐
│              base_mysql.py                              │
│  - Base (ORM基类)                                       │
│  - BaseCRUD (CRUD基类)                                   │
│  - session_dict (数据库会话字典)                        │
└───────┬───────────────────────────────┬─────────────────┘
        │ 导入                            │ 导入
        │                                 │
        ▼                                 ▼
┌──────────────────────────┐  ┌──────────────────────────┐
│ NsfcTopicRcmdModels.py   │  │    data_cleaner.py       │
│                          │  │                          │
│ - 定义ORM模型类          │  │ - 数据清洗逻辑           │
│ - 定义CRUD模型类         │  │ - 调用模型类方法         │
│ - 实现数据库操作方法     │  │ - 数据处理和标准化       │
└──────────────────────────┘  └──────────────────────────┘
```

## 二、详细调用关系

### 1. base_mysql.py

**位置**: 项目根目录

**导入的模块**:
```python
from application.settings import DATABASES  # 导入数据库配置
from sqlalchemy import create_engine, ...  # SQLAlchemy相关
```

**导出的内容**:
- `Base` - ORM模型的基类（declarative_base）
- `BaseCRUD` - CRUD操作的基类
- `session_dict` - 数据库会话字典，键为数据库别名（如'medicine_test'）

**被谁调用**:
- ✅ `NsfcTopicRcmdModels.py` - 导入 `Base` 和 `BaseCRUD`
- ✅ `data_cleaner.py` - 导入 `session_dict`

**作用**:
- 初始化所有数据库连接（根据 `DATABASES` 配置）
- 提供ORM基类和CRUD基类
- 提供数据库会话工厂

### 2. application/NsfcTopicRcmdModels.py

**位置**: `application/` 目录

**导入的模块**:
```python
from base_mysql import Base, BaseCRUD  # 导入基类
from sqlalchemy import Column, Integer, JSON, text  # SQLAlchemy类型
```

**导出的内容**:
- `NsfcTopicRcmdTaskList` - ORM模型类（任务列表表）
- `NsfcTopicRcmdTaskTopicList` - ORM模型类（主题列表表）
- `NsfcTopicRcmdTaskAppInfo` - ORM模型类（应用信息表）
- `NsfcTopicRcmdTaskListModel` - CRUD模型类（任务列表）
- `NsfcTopicRcmdTaskTopicListModel` - CRUD模型类（主题列表）
- `NsfcTopicRcmdTaskAppInfoModel` - CRUD模型类（应用信息）

**被谁调用**:
- ✅ `data_cleaner.py` - 导入三个CRUD模型类

**内部调用关系**:
```python
# ORM模型类继承Base
class NsfcTopicRcmdTaskList(Base):
    ...

# CRUD模型类继承BaseCRUD
class NsfcTopicRcmdTaskListModel(BaseCRUD):
    model = NsfcTopicRcmdTaskList  # 关联ORM模型
    
    def fetch_records_for_cleaning(self, db, ...):
        # 调用父类方法
        self.get_list_info(db, field, where_conditions)  # ← 来自BaseCRUD
    
    def batch_update_field(self, db, ...):
        # 调用父类方法
        self.update_data_info(db, ...)  # ← 来自BaseCRUD
```

**作用**:
- 定义数据库表的ORM映射
- 封装数据库操作方法（查询、更新）
- 提供数据清洗专用的数据库操作接口

### 3. data_cleaner.py

**位置**: 项目根目录

**导入的模块**:
```python
import json  # 标准库

from base_mysql import session_dict  # 导入数据库会话字典

from application.NsfcTopicRcmdModels import (
    NsfcTopicRcmdTaskListModel,
    NsfcTopicRcmdTaskTopicListModel,
    NsfcTopicRcmdTaskAppInfoModel
)  # 导入CRUD模型类
```

**导出的内容**:
- `DataCleaner` - 数据清洗类
- `run_all()` - 执行所有清洗任务的函数

**调用关系**:
```python
# 1. 使用 session_dict 打开数据库连接
def _open_session(self):
    session_factory = session_dict.get(self.db_key)  # ← 来自base_mysql
    return session_factory()

# 2. 实例化模型类并调用其方法
def _fetch_records_with_condition(self, model_class, ...):
    model = model_class()  # ← 实例化NsfcTopicRcmdTaskListModel等
    return model.fetch_records_for_cleaning(session, ...)  # ← 调用模型类方法

def _write_updates(self, model_class, ...):
    model = model_class()  # ← 实例化模型类
    model.batch_update_field(session, ...)  # ← 调用模型类方法
```

**作用**:
- 实现数据清洗的业务逻辑
- 协调数据库操作和数据处理
- 提供统一的清洗流程

## 三、调用链分析

### 调用链1：查询数据

```
data_cleaner.py
  │
  └─> _fetch_records_with_condition()
        │
        ├─> _open_session()
        │     └─> session_dict.get()  ← base_mysql.py
        │
        └─> model.fetch_records_for_cleaning()
              │
              └─> self.get_list_info()  ← BaseCRUD (base_mysql.py)
                    └─> db.query(self.model)  ← SQLAlchemy
```

### 调用链2：更新数据

```
data_cleaner.py
  │
  └─> _write_updates()
        │
        ├─> _open_session()
        │     └─> session_dict.get()  ← base_mysql.py
        │
        └─> model.batch_update_field()
              │
              └─> self.update_data_info()  ← BaseCRUD (base_mysql.py)
                    └─> db.query(self.model).filter()  ← SQLAlchemy
```

### 调用链3：数据处理

```
data_cleaner.py
  │
  └─> _process_records()
        │
        └─> processor_func()  ← 回调函数
              │
              ├─> _process_breadth_search()  ← data_cleaner.py内部
              │     └─> _standardize_project_info()  ← data_cleaner.py内部
              │
              └─> _process_cited_articles()  ← data_cleaner.py内部
                    └─> _standardize_project_info()  ← data_cleaner.py内部
```

## 四、文件职责划分

### base_mysql.py（基础设施层）

**职责**:
- ✅ 数据库连接管理
- ✅ ORM基类定义
- ✅ CRUD基类定义
- ✅ 通用数据库操作方法

**特点**:
- 不依赖业务逻辑
- 可被多个模块复用
- 提供底层数据库操作能力

### NsfcTopicRcmdModels.py（数据访问层）

**职责**:
- ✅ 定义业务相关的ORM模型
- ✅ 封装业务相关的数据库操作
- ✅ 提供数据清洗专用的查询和更新方法

**特点**:
- 依赖 `base_mysql.py`
- 针对特定业务场景
- 封装了数据清洗相关的数据库操作

### data_cleaner.py（业务逻辑层）

**职责**:
- ✅ 实现数据清洗的业务逻辑
- ✅ 协调数据库操作和数据处理
- ✅ 提供统一的清洗流程

**特点**:
- 依赖 `base_mysql.py` 和 `NsfcTopicRcmdModels.py`
- 包含业务逻辑和数据处理逻辑
- 是用户直接调用的入口

## 五、依赖关系总结

### 依赖方向（从下到上）

```
┌─────────────────────────────────────┐
│   application/settings.py          │  ← 配置层
│   (数据库配置)                       │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│   base_mysql.py                     │  ← 基础设施层
│   (数据库连接、ORM基类、CRUD基类)    │
└──────────────┬──────────────────────┘
               │
               ├──────────────────┐
               │                  │
               ▼                  ▼
┌──────────────────────┐  ┌──────────────────────┐
│ NsfcTopicRcmdModels  │  │   data_cleaner.py   │  ← 业务层
│ (数据访问层)          │  │   (业务逻辑层)       │
└──────────────────────┘  └──────────────────────┘
```

### 导入关系表

| 文件 | 导入自 | 导入内容 | 用途 |
|------|--------|----------|------|
| `base_mysql.py` | `application.settings` | `DATABASES` | 获取数据库配置 |
| `NsfcTopicRcmdModels.py` | `base_mysql` | `Base`, `BaseCRUD` | 继承基类定义模型 |
| `data_cleaner.py` | `base_mysql` | `session_dict` | 获取数据库会话 |
| `data_cleaner.py` | `application.NsfcTopicRcmdModels` | 三个Model类 | 调用数据库操作方法 |

### 调用关系表

| 调用者 | 被调用者 | 调用方法 | 说明 |
|--------|----------|----------|------|
| `data_cleaner.py` | `base_mysql.py` | `session_dict.get()` | 获取数据库会话工厂 |
| `data_cleaner.py` | `NsfcTopicRcmdModels.py` | `model.fetch_records_for_cleaning()` | 查询需要清洗的记录 |
| `data_cleaner.py` | `NsfcTopicRcmdModels.py` | `model.batch_update_field()` | 批量更新数据 |
| `NsfcTopicRcmdModels.py` | `base_mysql.py` | `BaseCRUD.get_list_info()` | 查询列表数据 |
| `NsfcTopicRcmdModels.py` | `base_mysql.py` | `BaseCRUD.update_data_info()` | 更新数据 |

## 六、数据流向

### 完整的数据流向

```
1. 配置层
   application/settings.py
   └─> DATABASES = {...}  # 数据库配置

2. 基础设施层
   base_mysql.py
   ├─> 读取 DATABASES
   ├─> 创建数据库引擎
   ├─> 创建会话工厂
   └─> session_dict = {'medicine_test': SessionLocal, ...}

3. 数据访问层
   NsfcTopicRcmdModels.py
   ├─> 继承 Base 定义ORM模型
   ├─> 继承 BaseCRUD 定义CRUD模型
   └─> 实现业务相关的数据库操作方法

4. 业务逻辑层
   data_cleaner.py
   ├─> 使用 session_dict 打开数据库连接
   ├─> 实例化模型类
   ├─> 调用模型类方法查询数据
   ├─> 处理数据（清洗、标准化）
   └─> 调用模型类方法更新数据
```

## 七、关键设计模式

### 1. 分层架构

```
业务逻辑层 (data_cleaner.py)
    ↓ 调用
数据访问层 (NsfcTopicRcmdModels.py)
    ↓ 调用
基础设施层 (base_mysql.py)
    ↓ 使用
配置层 (application/settings.py)
```

### 2. 继承关系

```
Base (base_mysql.py)
  └─> NsfcTopicRcmdTaskList (NsfcTopicRcmdModels.py)

BaseCRUD (base_mysql.py)
  └─> NsfcTopicRcmdTaskListModel (NsfcTopicRcmdModels.py)
        └─> 重写/扩展方法: fetch_records_for_cleaning(), batch_update_field()
```

### 3. 依赖注入

```python
# data_cleaner.py 中通过参数传递模型类
def _fetch_records_with_condition(self, model_class, ...):
    model = model_class()  # 延迟实例化
    return model.fetch_records_for_cleaning(...)
```

## 八、总结

### 文件关系一句话总结

- **settings.py** → 提供数据库配置
- **base_mysql.py** → 提供数据库连接和基础CRUD能力
- **NsfcTopicRcmdModels.py** → 提供业务相关的ORM模型和数据库操作
- **data_cleaner.py** → 使用上述模块实现数据清洗业务逻辑

### 调用层次

1. **配置层**：`settings.py` - 纯配置，不调用其他文件
2. **基础设施层**：`base_mysql.py` - 只调用配置，提供基础能力
3. **数据访问层**：`NsfcTopicRcmdModels.py` - 调用基础设施，封装业务数据操作
4. **业务逻辑层**：`data_cleaner.py` - 调用数据访问层和基础设施层，实现业务逻辑

### 设计优势

- ✅ **职责清晰**：每个文件只负责自己的职责
- ✅ **低耦合**：通过接口和继承实现松耦合
- ✅ **易扩展**：新增模型只需在 `NsfcTopicRcmdModels.py` 中添加
- ✅ **易维护**：修改数据库操作只需修改对应层

